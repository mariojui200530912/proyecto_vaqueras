<div class="container py-5">
  
  @if (isLoading()) {
    <div class="d-flex justify-content-center align-items-center vh-50">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
    </div>
  } 
  
  @else if (isError()) {
    <div class="alert alert-danger d-flex align-items-center" role="alert">
      <i class="bi bi-exclamation-triangle-fill fs-4 me-2"></i>
      <div>
        <strong>Error:</strong> {{ mensajeError() }}
        <a routerLink="/" class="alert-link ms-2">Volver al inicio</a>
      </div>
    </div>
  } 
  
  @else if (perfilUsuario(); as user) {
    
    <div class="card shadow border-0 mb-5 overflow-hidden animate-fade-in">
      <div class="profile-cover"></div>
      <div class="card-body position-relative pt-0 pb-4 px-4">
        <div class="d-flex flex-column flex-md-row align-items-center gap-4 profile-header-content">
          
          <div class="position-relative">
            <img [src]="user.avatar" 
                 class="rounded-circle border border-4 border-white shadow bg-white profile-avatar" 
                 alt="Avatar de {{ user.nickname }}">
            
            <span class="position-absolute bottom-0 end-0 badge rounded-pill border border-2 border-white"
                  [ngClass]="{
                    'bg-warning text-dark': user.rol === 'ADMIN',
                    'bg-info text-dark': user.rol === 'EMPRESA',
                    'bg-primary': user.rol === 'GAMER'
                  }">
              {{ user.rol }}
            </span>
          </div>
          
          <div class="text-center text-md-start flex-grow-1 mt-2 mt-md-0">
            <h1 class="fw-bold mb-0 d-flex align-items-center justify-content-center justify-content-md-start gap-2">
              {{ user.nickname }}
              @if (esMiPerfil()) {
                <span class="badge bg-primary fs-6 align-middle">Tú</span>
              }
            </h1>
            
            <div class="d-flex justify-content-center justify-content-md-start gap-3 mt-2 text-muted">
              <span><i class="bi bi-geo-alt-fill text-danger"></i> {{ user.pais || 'Desconocido' }}</span>
              <span><i class="bi bi-envelope-fill text-primary"></i> {{ user.email }}</span>
            </div>

            @if (esMiPerfil()) {
              <div class="mt-3 p-2 bg-light rounded border d-inline-flex align-items-center gap-3 shadow-sm">
                <div class="form-check form-switch mb-0">
                  <input class="form-check-input cursor-pointer" type="checkbox" role="switch" 
                         id="privacySwitch"
                         [checked]="bibliotecaEsPublica()" 
                         (change)="togglePrivacidad()">
                  <label class="form-check-label small fw-bold cursor-pointer user-select-none" for="privacySwitch">
                    Biblioteca Pública
                  </label>
                </div>
                <div class="vr"></div>
                <small class="text-muted d-flex align-items-center gap-1" style="font-size: 0.75rem;">
                  @if (bibliotecaEsPublica()) {
                    <i class="bi bi-globe text-success"></i> Visible para todos
                  } @else {
                    <i class="bi bi-lock-fill text-danger"></i> Solo tú
                  }
                </small>
              </div>
            }
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex align-items-center justify-content-between mb-4 border-bottom pb-2 animate-slide-up">
      <div class="d-flex align-items-center gap-2">
        <h3 class="fw-bold mb-0 text-dark">
          <i class="bi bi-collection-play-fill text-primary"></i> Biblioteca
        </h3>
        @if (esMiPerfil() || user.bibliotecaPublica) {
          <span class="badge bg-secondary rounded-pill">{{ bibliotecaService.miBiblioteca().length }}</span>
        }
      </div>
      
      @if (!esMiPerfil()) {
         @if (!user.bibliotecaPublica) {
            <span class="badge bg-danger"><i class="bi bi-lock-fill"></i> Privada</span>
         } @else {
            <span class="badge bg-success"><i class="bi bi-unlock-fill"></i> Pública</span>
         }
      }
    </div>

    @if (!user.bibliotecaPublica && !esMiPerfil()) {
      <div class="alert alert-secondary d-flex flex-column align-items-center justify-content-center p-5 rounded-3 shadow-sm animate-fade-in text-center">
        <div class="bg-white p-3 rounded-circle shadow-sm mb-3">
            <i class="bi bi-lock-fill fs-1 text-secondary"></i>
        </div>
        <h4 class="alert-heading fw-bold mb-2">Este perfil es privado</h4>
        <p class="mb-0 text-muted" style="max-width: 500px;">
          {{ user.nickname }} ha configurado su biblioteca de juegos para que solo sea visible por él mismo.
        </p>
      </div>
    } 
    
    @else {
      <div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-4 animate-slide-up">
        
        @for (juego of bibliotecaService.miBiblioteca(); track juego.idJuego) {
          <div class="col">
            <div class="card h-100 shadow-sm border-0 game-card">
              
              <div class="position-relative overflow-hidden">
                <img [src]="juego.portada" class="card-img-top zoom-effect" 
                     style="height: 220px; object-fit: cover;" 
                     alt="{{ juego.titulo }}">
                
                <div class="game-overlay d-flex align-items-center justify-content-center">
                   <a [routerLink]="['/juego', juego.idJuego]" class="btn btn-light btn-sm fw-bold rounded-pill px-3 shadow">
                      Ver Ficha
                   </a>
                </div>
              </div>
              
              <div class="card-body p-3">
                <h6 class="card-title text-truncate fw-bold mb-1 text-dark" title="{{ juego.titulo }}">
                  {{ juego.titulo }}
                </h6>
                
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <span class="badge bg-light text-secondary border" style="font-size: 0.7rem;">
                    {{ juego.clasificacion }}
                  </span>
                  
                  @if (juego.jugadoHoras > 0) {
                     <small class="text-primary fw-bold" style="font-size: 0.75rem;">
                        <i class="bi bi-clock-history"></i> {{ juego.jugadoHoras }}h
                     </small>
                  } @else {
                     <small class="text-muted fst-italic" style="font-size: 0.7rem;">Nuevo</small>
                  }
                </div>
              </div>

            </div>
          </div>
        } @empty {
          <div class="col-12 text-center py-5">
            <div class="mb-3">
               <i class="bi bi-controller fs-1 text-muted opacity-25"></i>
            </div>
            <h5 class="text-muted fw-bold">Biblioteca Vacía</h5>
            <p class="text-muted small">Este usuario aún no ha adquirido juegos.</p>
          </div>
        }
      </div>
    }

  }
</div>