<!-- Created with Jaspersoft Studio version 7.0.3.final using JasperReports Library version 7.0.3-41034ca841d452f3305ba55b9042260aaa1ab5dd  -->
<jasperReport name="TopVentasCalidad" language="java" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="549b857c-5fd3-4056-a120-ac49157c628a">
	<parameter name="FECHA_INICIO" class="java.lang.String"/>
	<parameter name="FECHA_FIN" class="java.lang.String"/>
	<parameter name="ID_CATEGORIA" class="java.lang.Integer"/>
	<parameter name="CLASIFICACION" class="java.lang.String"/>
	<query language="sql"><![CDATA[SELECT
            j.titulo,
            e.nombre AS empresa,
            j.clasificacion,
            j.precio,
            COUNT(DISTINCT v.id) as total_ventas,
            j.calificacion_promedio,
            -- ALGORITMO DE BALANCE (Promedio Bayesiano)
            -- m=5 (mínimo ventas), C=3.0 (media global)
            ( (COUNT(DISTINCT v.id) / (COUNT(DISTINCT v.id) + 5.0)) * j.calificacion_promedio ) +
            ( (5.0 / (COUNT(DISTINCT v.id) + 5.0)) * 3.0 ) AS score_balance
        FROM juego j
        INNER JOIN empresa e ON j.id_empresa_creadora = e.id
        INNER JOIN venta v ON j.id = v.id_juego
        LEFT JOIN juego_categoria jc ON j.id = jc.id_juego
        WHERE
            v.fecha_compra BETWEEN $P{FECHA_INICIO} AND $P{FECHA_FIN}
            -- Filtro dinámico: Si el parámetro es NULL, ignora el filtro
            AND ($P{ID_CATEGORIA} IS NULL OR jc.id_categoria = $P{ID_CATEGORIA})
            AND ($P{CLASIFICACION} IS NULL OR j.clasificacion = $P{CLASIFICACION})
        GROUP BY j.id
        ORDER BY score_balance DESC
        LIMIT 20]]></query>
	<field name="titulo" class="java.lang.String"/>
	<field name="empresa" class="java.lang.String"/>
	<field name="clasificacion" class="java.lang.String"/>
	<field name="total_ventas" class="java.lang.Long"/>
	<field name="calificacion_promedio" class="java.lang.Double"/>
	<field name="score_balance" class="java.lang.Double"/>
	<background splitType="Stretch"/>
	<title height="85">
		<element kind="rectangle" uuid="20a89d63-bc7e-4e08-8650-27cb165afc6d" x="-20" y="0" width="595" height="85" backcolor="#1A237E">
			<pen lineWidth="0.0"/>
		</element>
		<element kind="staticText" uuid="efd837fe-4a92-4401-8555-3e6751fb9d35" x="0" y="10" width="555" height="30" forecolor="#FFFFFF" fontSize="22.0" bold="true" hTextAlign="Center">
			<text><![CDATA[Top Juegos: Ventas & Calidad]]></text>
		</element>
		<element kind="textField" uuid="525e3822-1da1-4a72-9363-7b67af68e738" x="0" y="45" width="555" height="20" forecolor="#C5CAE9" hTextAlign="Center">
			<expression><![CDATA["Del " + $P{FECHA_INICIO} + " al " + $P{FECHA_FIN}]]></expression>
		</element>
		<element kind="textField" uuid="3894788b-892d-4688-8a6d-f45d274d13b1" x="0" y="65" width="555" height="15" forecolor="#9FA8DA" fontSize="9.0" italic="true" hTextAlign="Center">
			<expression><![CDATA[($P{ID_CATEGORIA} != null ? "Filtro Categ. ID: " + $P{ID_CATEGORIA} + " | " : "") + ($P{CLASIFICACION} != null ? "Clasificación: " + $P{CLASIFICACION} : "")]]></expression>
		</element>
	</title>
	<columnHeader height="30">
		<element kind="staticText" uuid="2a26fc00-f23c-4bf3-a9d9-6e91e3a33ee4" x="0" y="0" width="180" height="30" bold="true" vTextAlign="Middle">
			<text><![CDATA[Juego / Empresa]]></text>
		</element>
		<element kind="staticText" uuid="720b0e17-e801-4a1c-bcab-2d9cc48cb004" x="180" y="0" width="60" height="30" bold="true" hTextAlign="Center" vTextAlign="Middle">
			<text><![CDATA[Clasif.]]></text>
		</element>
		<element kind="staticText" uuid="b76082b6-fc49-4831-9e37-90934ee5a5d9" x="240" y="0" width="70" height="30" bold="true" hTextAlign="Center" vTextAlign="Middle">
			<text><![CDATA[Ventas]]></text>
		</element>
		<element kind="staticText" uuid="ebed65f8-583c-4f2b-a536-0035f128c870" x="310" y="0" width="80" height="30" bold="true" hTextAlign="Center" vTextAlign="Middle">
			<text><![CDATA[Rating Real]]></text>
		</element>
		<element kind="staticText" uuid="2c4a8f5d-903f-44c1-a3a7-44ec9f59c986" x="390" y="0" width="165" height="30" bold="true" hTextAlign="Right" vTextAlign="Middle">
			<text><![CDATA[Puntaje Balanceado (Score)]]></text>
		</element>
	</columnHeader>
	<detail>
		<band height="40">
			<element kind="textField" uuid="ff97ca11-1dc7-4d23-82d5-a6349b298db0" x="0" y="0" width="180" height="20" bold="true">
				<expression><![CDATA[$F{titulo}]]></expression>
			</element>
			<element kind="textField" uuid="ac9cc995-d3cd-446f-9cb7-ee9d6fed6e24" x="0" y="20" width="180" height="15" forecolor="#666666" fontSize="9.0">
				<expression><![CDATA[$F{empresa}]]></expression>
			</element>
			<element kind="textField" uuid="dcb5d216-09ed-417e-b219-8c28e1e13cc7" x="180" y="0" width="60" height="35" hTextAlign="Center" vTextAlign="Middle">
				<expression><![CDATA[$F{clasificacion}]]></expression>
			</element>
			<element kind="textField" uuid="c65616cb-6a09-4d44-8a1e-9cbeb4bc1424" x="240" y="0" width="70" height="35" hTextAlign="Center" vTextAlign="Middle">
				<expression><![CDATA[$F{total_ventas}]]></expression>
			</element>
			<element kind="textField" uuid="784e98e5-55c6-4ad4-beef-28f584cf0859" x="310" y="0" width="80" height="35" forecolor="#F9A825" bold="true" hTextAlign="Center" vTextAlign="Middle">
				<expression><![CDATA[$F{calificacion_promedio} + " ★"]]></expression>
			</element>
			<element kind="textField" uuid="f4411418-e005-415b-b701-a2c18b84ec27" x="390" y="0" width="165" height="35" forecolor="#2E7D32" fontSize="14.0" pattern="#,##0.00" bold="true" hTextAlign="Right" vTextAlign="Middle">
				<expression><![CDATA[$F{score_balance}]]></expression>
			</element>
		</band>
	</detail>
</jasperReport>
